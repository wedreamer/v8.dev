***

标题： “自定义启动快照”
作者： '杨果 （[@hashseed](https://twitter.com/hashseed)），软件工程师和发动机预热器供应商
化身：

*   “阳国”
    日期： 2015-09-25 13：33：37
    标签：
*   内部
    描述： “V8 嵌入器可以利用快照来跳过 JavaScript 程序初始化所产生的启动时间。

***

JavaScript规范包括许多内置功能，从[数学函数](https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Math)到[功能齐全的正则表达式引擎](https://developer.mozilla.org/en/docs/Web/JavaScript/Guide/Regular_Expressions).每个新创建的 V8 上下文从一开始就具有这些功能。为此，必须在创建上下文时设置全局对象（例如，浏览器中的窗口对象）和所有内置功能并将其初始化到 V8 的堆中。从头开始执行此操作需要相当长的时间。

幸运的是，V8 使用了一个快捷方式来加快速度：就像解冻冷冻的披萨做一顿快餐一样，我们将以前准备的快照直接反序列化到堆中，以获得初始化的上下文。在常规台式计算机上，这可以使创建上下文的时间从 40 毫秒减少到不到 2 毫秒。在普通的手机上，这可能意味着270毫秒和10毫秒之间的差异。

除Chrome之外，嵌入V8的应用程序可能需要比vanilla Javascript更多的功能。许多在启动时加载其他库脚本，在“实际”应用程序运行之前。例如，基于 V8 的简单 TypeScript VM 必须在启动时加载 TypeScript 编译器，以便将 TypeScript 源代码即时转换为 JavaScript。

从两个月前发布的 V8 v4.3 开始，嵌入者可以利用快照来跳过此类初始化产生的启动时间。这[测试用例](https://chromium.googlesource.com/v8/v8.git/+/4.5.103.9/test/cctest/test-serialize.cc#661)，则显示此 API 的工作原理。

要创建快照，我们可以调用`v8::V8::CreateSnapshotDataBlob`将要嵌入的脚本作为空终止的 C 字符串。创建新上下文后，将编译并执行此脚本。在我们的示例中，我们创建了两个自定义启动快照，每个快照都在 JavaScript 已经内置的内容之上定义函数。

然后我们可以使用`v8::Isolate::CreateParams`以配置新创建的隔离，以便从自定义启动快照初始化上下文。在该隔离中创建的上下文是我们从中拍摄快照的上下文的精确副本。快照中定义的函数可用，而无需再次定义它们。

这有一个重要的限制：快照只能捕获 V8 的堆。在创建快照时，V8 与外部的任何交互都是禁止的。此类交互包括：

*   定义和调用 API 回调（即通过以下方式创建的函数）`v8::FunctionTemplate`)
*   创建类型化数组，因为后备存储可能在 V8 外部分配

当然，还有来自来源的值，例如`Math.random`或`Date.now`在捕获快照后修复。它们不再是真正的随机，也不反映当前时间。

除了限制之外，启动快照仍然是节省初始化时间的好方法。我们可以从启动中减少100毫秒，在上面的示例中加载TypeScript编译器（在常规台式计算机上）。我们期待了解如何使用自定义快照！
