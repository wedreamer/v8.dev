***

æ ‡é¢˜ï¼š â€œæ›´å¿«çš„å¼‚æ­¥å‡½æ•°å’Œæ‰¿è¯ºâ€
ä½œè€…ï¼š 'ç›é›…Â·é˜¿ç±³æ‹‰è¯ºå¨ƒ ï¼ˆ[@Zmayski](https://twitter.com/Zmayski)ï¼‰ï¼Œæ°¸è¿œç­‰å¾…çš„æœŸå¾…è€…ï¼Œä»¥åŠBenedikt Meurerï¼ˆ[@bmeurer](https://twitter.com/bmeurer)ï¼‰ï¼Œä¸“ä¸šæ€§èƒ½ä¿è¯è€…
åŒ–èº«ï¼š

*   'ç›é›…-å†›é˜Ÿ'
*   'benedikt-meurer'
    æ—¥æœŸï¼š 2018-11-12 16ï¼š45ï¼š07
    æ ‡ç­¾ï¼š
*   ECMAScript
*   åŸºå‡†
*   ä»‹ç»
    æè¿°ï¼š â€œæ›´å¿«ï¼Œæ›´æ˜“äºè°ƒè¯•çš„å¼‚æ­¥å‡½æ•°å’Œæ‰¿è¯ºå³å°†å‡ºç°åœ¨V8 v7.2 / Chrome 72ä¸­ã€‚
    æ¨æ–‡ï¼šâ€œ1062000102909169670â€

***

JavaScriptä¸­çš„å¼‚æ­¥å¤„ç†ä¼ ç»Ÿä¸Šä»¥ä¸æ˜¯ç‰¹åˆ«å¿«è€Œé—»åã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œè°ƒè¯•å®æ—¶JavaScriptåº”ç”¨ç¨‹åºï¼ˆ ç‰¹åˆ«æ˜¯Node.jsæœåŠ¡å™¨ - å¹¶éæ˜“äº‹ï¼Œ*ç‰¹åˆ«æ˜¯*å½“æ¶‰åŠåˆ°å¼‚æ­¥ç¼–ç¨‹æ—¶ã€‚å¹¸è¿çš„æ˜¯ï¼Œæ—¶ä»£åœ¨å˜åŒ–ã€‚æœ¬æ–‡æ¢è®¨äº†æˆ‘ä»¬å¦‚ä½•åœ¨ V8 ä¸­ä¼˜åŒ–å¼‚æ­¥å‡½æ•°å’Œæ‰¿è¯ºï¼ˆåœ¨æŸç§ç¨‹åº¦ä¸Šåœ¨å…¶ä»– JavaScript å¼•æ“ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ï¼Œå¹¶æè¿°æˆ‘ä»¬å¦‚ä½•æ”¹è¿›å¼‚æ­¥ä»£ç çš„è°ƒè¯•ä½“éªŒã€‚

ï¼šï¼šï¼šå¤‡æ³¨
**æ³¨æ„ï¼š**å¦‚æœæ‚¨æ›´å–œæ¬¢è§‚çœ‹æ¼”ç¤ºæ–‡ç¨¿è€Œä¸æ˜¯é˜…è¯»æ–‡ç« ï¼Œé‚£ä¹ˆè¯·æ¬£èµä¸‹é¢çš„è§†é¢‘ï¼å¦‚æœæ²¡æœ‰ï¼Œè¯·è·³è¿‡è§†é¢‘å¹¶ç»§ç»­é˜…è¯»ã€‚
:::

<figure>
  <div class="video video-16:9">
    <iframe src="https://www.youtube.com/embed/DFP5DKDQfOc" width="640" height="360" loading="lazy"></iframe>
  </div>
</figure>

## å¼‚æ­¥ç¼–ç¨‹çš„æ–°æ–¹æ³•

### ä»å›è°ƒåˆ°æ‰¿è¯ºå†åˆ°å¼‚æ­¥å‡½æ•°

åœ¨æ‰¿è¯ºæˆä¸ºJavaScriptè¯­è¨€çš„ä¸€éƒ¨åˆ†ä¹‹å‰ï¼ŒåŸºäºå›è°ƒçš„APIé€šå¸¸ç”¨äºå¼‚æ­¥ä»£ç ï¼Œç‰¹åˆ«æ˜¯åœ¨Node.jsä¸­ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

```js
function handler(done) {
  validateParams((error) => {
    if (error) return done(error);
    dbQuery((error, dbResults) => {
      if (error) return done(error);
      serviceCall(dbResults, (error, serviceResults) => {
        console.log(result);
        done(error, serviceResults);
      });
    });
  });
}
```

ä»¥è¿™ç§æ–¹å¼ä½¿ç”¨æ·±åº¦åµŒå¥—å›è°ƒçš„ç‰¹å®šæ¨¡å¼é€šå¸¸ç§°ä¸º*â€œå›è°ƒåœ°ç‹±â€*ï¼Œå› ä¸ºå®ƒä½¿ä»£ç çš„å¯è¯»æ€§é™ä½ä¸”éš¾ä»¥ç»´æŠ¤ã€‚

å¹¸è¿çš„æ˜¯ï¼Œç°åœ¨æ‰¿è¯ºæ˜¯JavaScriptè¯­è¨€çš„ä¸€éƒ¨åˆ†ï¼ŒåŒæ ·çš„ä»£ç å¯ä»¥ä»¥æ›´ä¼˜é›…å’Œå¯ç»´æŠ¤çš„æ–¹å¼ç¼–å†™ï¼š

```js
function handler() {
  return validateParams()
    .then(dbQuery)
    .then(serviceCall)
    .then(result => {
      console.log(result);
      return result;
    });
}
```

æœ€è¿‘ï¼ŒJavaScript è·å¾—äº†å¯¹[å¼‚æ­¥å‡½æ•°](https://developers.google.com/web/fundamentals/primers/async-functions).ç°åœ¨ï¼Œä¸Šè¿°å¼‚æ­¥ä»£ç çš„ç¼–å†™æ–¹å¼çœ‹èµ·æ¥ä¸åŒæ­¥ä»£ç éå¸¸ç›¸ä¼¼ï¼š

```js
async function handler() {
  await validateParams();
  const dbResults = await dbQuery();
  const results = await serviceCall(dbResults);
  console.log(results);
  return results;
}
```

ä½¿ç”¨å¼‚æ­¥å‡½æ•°ï¼Œä»£ç å˜å¾—æ›´åŠ ç®€æ´ï¼Œå¹¶ä¸”æ§åˆ¶å’Œæ•°æ®æµæ›´å®¹æ˜“éµå¾ªï¼Œå°½ç®¡æ‰§è¡Œä»ç„¶æ˜¯å¼‚æ­¥çš„ã€‚ï¼ˆè¯·æ³¨æ„ï¼ŒJavaScript æ‰§è¡Œä»ç„¶å‘ç”Ÿåœ¨å•ä¸ªçº¿ç¨‹ä¸­ï¼Œè¿™æ„å‘³ç€å¼‚æ­¥å‡½æ•°æœ€ç»ˆä¸ä¼šè‡ªå·±åˆ›å»ºç‰©ç†çº¿ç¨‹ã€‚

### ä»äº‹ä»¶ä¾¦å¬å™¨å›è°ƒåˆ°å¼‚æ­¥è¿­ä»£

å¦ä¸€ä¸ªåœ¨ Node ä¸­ç‰¹åˆ«å¸¸è§çš„å¼‚æ­¥èŒƒå¼.jsæ˜¯[`ReadableStream`s](https://nodejs.org/api/stream.html#stream_readable_streams).ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

```js
const http = require('http');

http.createServer((req, res) => {
  let body = '';
  req.setEncoding('utf8');
  req.on('data', (chunk) => {
    body += chunk;
  });
  req.on('end', () => {
    res.write(body);
    res.end();
  });
}).listen(1337);
```

æ­¤ä»£ç å¯èƒ½æœ‰ç‚¹éš¾ä»¥éµå¾ªï¼šä¼ å…¥çš„æ•°æ®åœ¨åªèƒ½åœ¨å›è°ƒä¸­è®¿é—®çš„å—ä¸­å¤„ç†ï¼Œå¹¶ä¸”æµç»“æŸä¿¡ä»¤ä¹Ÿå‘ç”Ÿåœ¨å›è°ƒä¸­ã€‚å½“æ‚¨æ²¡æœ‰æ„è¯†åˆ°å‡½æ•°ä¼šç«‹å³ç»ˆæ­¢å¹¶ä¸”å®é™…å¤„ç†å¿…é¡»åœ¨å›è°ƒä¸­å‘ç”Ÿæ—¶ï¼Œå¾ˆå®¹æ˜“åœ¨æ­¤å¤„å¼•å…¥é”™è¯¯ã€‚

å¹¸è¿çš„æ˜¯ï¼Œä¸€ä¸ªå¾ˆé…·çš„æ–°çš„ES2018åŠŸèƒ½å«åš[å¼‚æ­¥è¿­ä»£](http://2ality.com/2016/10/asynchronous-iteration.html)å¯ä»¥ç®€åŒ–æ­¤ä»£ç ï¼š

```js
const http = require('http');

http.createServer(async (req, res) => {
  try {
    let body = '';
    req.setEncoding('utf8');
    for await (const chunk of req) {
      body += chunk;
    }
    res.write(body);
    res.end();
  } catch {
    res.statusCode = 500;
    res.end();
  }
}).listen(1337);
```

è€Œä¸æ˜¯å°†å¤„ç†å®é™…è¯·æ±‚å¤„ç†çš„é€»è¾‘æ”¾å…¥ä¸¤ä¸ªä¸åŒçš„å›è°ƒä¸­ â€”`'data'`å’Œ`'end'`å›è°ƒ â€” æˆ‘ä»¬ç°åœ¨å¯ä»¥å°†æ‰€æœ‰å†…å®¹æ”¾å…¥å•ä¸ªå¼‚æ­¥å‡½æ•°ä¸­ï¼Œå¹¶ä½¿ç”¨æ–°çš„`for awaitâ€¦of`å¾ªç¯ä»¥å¼‚æ­¥æ–¹å¼å¾ªç¯è®¿é—®å—ã€‚æˆ‘ä»¬è¿˜æ·»åŠ äº†ä¸€ä¸ª`try-catch`é˜»æ­¢ä»¥é¿å…`unhandledRejection`é—®é¢˜\[^1]ã€‚

\[^1]ï¼š æ„Ÿè°¢[é©¬æ³°å¥¥Â·ç§‘åˆ©çº³](https://twitter.com/matteocollina)å°†æˆ‘ä»¬æŒ‡å‘[æ­¤é—®é¢˜](https://github.com/mcollina/make-promises-safe/blob/master/README.md#the-unhandledrejection-problem).

æ‚¨ç°åœ¨å°±å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨è¿™äº›æ–°åŠŸèƒ½äº†ï¼å¼‚æ­¥å‡½æ•°æ˜¯**å®Œå…¨æ”¯æŒä» Node.js 8 ï¼ˆV8 v6.2 / Chrome 62ï¼‰ å¼€å§‹**ï¼Œè€Œå¼‚æ­¥è¿­ä»£å™¨å’Œç”Ÿæˆå™¨æ˜¯**ä» Node.js 10 ï¼ˆV8 v6.8 / Chrome 68ï¼‰ å¼€å§‹å®Œå…¨æ”¯æŒ**!

## å¼‚æ­¥æ€§èƒ½æ”¹è¿›

æˆ‘ä»¬å·²ç»è®¾æ³•åœ¨ V8 v5.5ï¼ˆChrome 55 & Node.js 7ï¼‰ å’Œ V8 v6.8 ï¼ˆChrome 68 & Node.js 10ï¼‰ ä¹‹é—´æ˜¾è‘—æé«˜äº†å¼‚æ­¥ä»£ç çš„æ€§èƒ½ã€‚æˆ‘ä»¬è¾¾åˆ°äº†ä¸€ä¸ªæ€§èƒ½æ°´å¹³ï¼Œå¼€å‘äººå‘˜å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨è¿™äº›æ–°çš„ç¼–ç¨‹èŒƒä¾‹ï¼Œè€Œä¸å¿…æ‹…å¿ƒé€Ÿåº¦ã€‚

![](../_img/fast-async/doxbee-benchmark.svg)

ä¸Šå›¾æ˜¾ç¤ºäº†[doxbee benchmark](https://github.com/v8/promise-performance-tests/blob/master/lib/doxbee-async.js)ï¼Œç”¨äºè¡¡é‡å¤§é‡æ‰¿è¯ºä»£ç çš„æ€§èƒ½ã€‚è¯·æ³¨æ„ï¼Œå›¾è¡¨å¯è§†åŒ–æ‰§è¡Œæ—¶é—´ï¼Œè¿™æ„å‘³ç€è¶Šä½è¶Šå¥½ã€‚

ç»“æœ[å¹¶è¡ŒåŸºå‡†æµ‹è¯•](https://github.com/v8/promise-performance-tests/blob/master/lib/parallel-async.js)ï¼Œå…¶ä¸­ç‰¹åˆ«å¼ºè°ƒæ€§èƒ½[`Promise.all()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all)ï¼Œæ›´ä»¤äººå…´å¥‹ï¼š

![](../_img/fast-async/parallel-benchmark.svg)

æˆ‘ä»¬è®¾æ³•æ”¹è¿›`Promise.all`æ€§èƒ½ç³»æ•°**8Ã—**.

ä½†æ˜¯ï¼Œä¸Šè¿°åŸºå‡†æ˜¯åˆæˆçš„å¾®è§‚åŸºå‡†ã€‚V8 å›¢é˜Ÿå¯¹æˆ‘ä»¬çš„ä¼˜åŒ–å¦‚ä½•å½±å“æ›´æ„Ÿå…´è¶£[å®é™…ç”¨æˆ·ä»£ç çš„å®é™…æ€§èƒ½](/blog/real-world-performance).

![](../_img/fast-async/http-benchmarks.svg)

ä¸Šå›¾æ˜¾ç¤ºäº†ä¸€äº›æµè¡Œçš„HTTPä¸­é—´ä»¶æ¡†æ¶çš„æ€§èƒ½ï¼Œè¿™äº›æ¡†æ¶å¤§é‡ä½¿ç”¨æ‰¿è¯ºå’Œ`async`åŠŸèƒ½ã€‚è¯·æ³¨æ„ï¼Œæ­¤å›¾æ˜¾ç¤ºæ¯ç§’çš„è¯·æ±‚æ•°ï¼Œå› æ­¤ä¸å‰é¢çš„å›¾è¡¨ä¸åŒï¼Œè¶Šé«˜è¶Šå¥½ã€‚è¿™äº›æ¡†æ¶çš„æ€§èƒ½åœ¨ Node.js 7 ï¼ˆV8 v5.5ï¼‰ å’Œ Node.js 10 ï¼ˆV8 v6.8ï¼‰ ä¹‹é—´æ˜¾è‘—æé«˜ã€‚

è¿™äº›æ€§èƒ½æ”¹è¿›æ˜¯ä¸‰ä¸ªå…³é”®æˆå°±çš„ç»“æœï¼š

*   [æ¶¡è½®é£æ‰‡](/docs/turbofan)ï¼Œæ–°çš„ä¼˜åŒ–ç¼–è¯‘å™¨ ğŸ‰
*   [å¥¥é‡Œè¯ºç§‘æ²³](/blog/orinoco)ï¼Œæ–°çš„åƒåœ¾å›æ”¶å™¨ ğŸš›
*   ä¸€ä¸ªèŠ‚ç‚¹.js 8 ä¸ªé”™è¯¯å¯¼è‡´`await`è·³è¿‡å¾®åˆ†æµ ğŸ›

å½“æˆ‘ä»¬[æ¨å‡ºæ¶¡è½®é£æ‰‡](/blog/launching-ignition-and-turbofan)åœ¨[èŠ‚ç‚¹.js 8](https://medium.com/the-node-js-collection/node-js-8-3-0-is-now-available-shipping-with-the-ignition-turbofan-execution-pipeline-aa5875ad3367)ï¼Œè¿™ç»™æ•´ä¸ªæ€§èƒ½å¸¦æ¥äº†å·¨å¤§çš„æå‡ã€‚

æˆ‘ä»¬è¿˜ä¸€ç›´åœ¨ç ”ç©¶ä¸€ä¸ªæ–°çš„åƒåœ¾å›æ”¶å™¨ï¼Œç§°ä¸ºOrinocoï¼Œå®ƒå°†åƒåœ¾å›æ”¶å·¥ä½œä»ä¸»çº¿ç¨‹ä¸­ç§»å‡ºï¼Œä»è€Œæ˜¾ç€æ”¹å–„äº†è¯·æ±‚å¤„ç†ã€‚

æœ€åä½†å¹¶éæœ€ä¸é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼ŒNodeä¸­æœ‰ä¸€ä¸ªæ–¹ä¾¿çš„é”™è¯¯.js 8å¯¼è‡´`await`åœ¨æŸäº›æƒ…å†µä¸‹è·³è¿‡å¾®åˆ†æµï¼Œä»è€Œè·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚è¯¥é”™è¯¯æœ€åˆæ˜¯ä¸€ä¸ªæ„å¤–çš„è§„èŒƒå†²çªï¼Œä½†åæ¥å®ƒç»™äº†æˆ‘ä»¬ä¼˜åŒ–çš„æƒ³æ³•ã€‚è®©æˆ‘ä»¬ä»è§£é‡Šé”™è¯¯è¡Œä¸ºå¼€å§‹ï¼š

```js
const p = Promise.resolve();

(async () => {
  await p; console.log('after:await');
})();

p.then(() => console.log('tick:a'))
 .then(() => console.log('tick:b'));
```

ä¸Šè¿°ç¨‹åºåˆ›å»ºäº†ä¸€ä¸ªå·²å…‘ç°çš„æ‰¿è¯º`p`å’Œ`await`çš„ç»“æœï¼Œä½†ä¹Ÿå°†ä¸¤ä¸ªå¤„ç†ç¨‹åºé“¾æ¥åˆ°å®ƒä¸Šé¢ã€‚æ‚¨æœŸæœ›ä»¥å“ªç§é¡ºåº`console.log`è¦æ‰§è¡Œçš„è°ƒç”¨ï¼Ÿ

å› ä¸º`p`å·²å®ç°ï¼Œæ‚¨å¯èƒ½å¸Œæœ›å®ƒæ‰“å°`'after:await'`é¦–å…ˆï¼Œç„¶åæ˜¯`'tick'`s.äº‹å®ä¸Šï¼Œè¿™å°±æ˜¯ä½ åœ¨ Node.js 8 ä¸­å¾—åˆ°çš„è¡Œä¸ºï¼š

![The await bug in Node.js 8](../_img/fast-async/await-bug-node-8.svg)

å°½ç®¡æ­¤è¡Œä¸ºçœ‹èµ·æ¥å¾ˆç›´è§‚ï¼Œä½†æ ¹æ®è§„èŒƒï¼Œå®ƒæ˜¯ä¸æ­£ç¡®çš„ã€‚Node.js 10 å®ç°äº†æ­£ç¡®çš„è¡Œä¸ºï¼Œå³é¦–å…ˆæ‰§è¡Œé“¾æ¥çš„å¤„ç†ç¨‹åºï¼Œç„¶åæ‰ç»§ç»­æ‰§è¡Œå¼‚æ­¥å‡½æ•°ã€‚

![Node.js 10 no longer has the await bug](../_img/fast-async/await-bug-node-10.svg)

è¿™*â€œæ­£ç¡®çš„è¡Œä¸ºâ€*å¯ä»¥è¯´ä¸æ˜¯å¾ˆæ˜æ˜¾ï¼Œå®é™…ä¸Šè®©JavaScriptå¼€å‘äººå‘˜æ„Ÿåˆ°æƒŠè®¶ï¼Œæ‰€ä»¥å®ƒå€¼å¾—ä¸€äº›è§£é‡Šã€‚åœ¨æˆ‘ä»¬æ·±å…¥æ¢è®¨æ‰¿è¯ºå’Œå¼‚æ­¥å‡½æ•°çš„ç¥å¥‡ä¸–ç•Œä¹‹å‰ï¼Œè®©æˆ‘ä»¬ä»ä¸€äº›åŸºç¡€å¼€å§‹ã€‚

### ä»»åŠ¡ä¸å¾®ä»»åŠ¡

åœ¨é«˜å±‚æ¬¡ä¸Šæœ‰*ä»»åŠ¡*å’Œ*å¾®ä»»åŠ¡*åœ¨ JavaScript ä¸­ã€‚ä»»åŠ¡å¤„ç† I/O å’Œè®¡æ—¶å™¨ç­‰äº‹ä»¶ï¼Œå¹¶ä¸€æ¬¡æ‰§è¡Œä¸€ä¸ªã€‚å¾®ä»»åŠ¡å®ç° å»¶è¿Ÿæ‰§è¡Œ`async`/`await`å¹¶æ‰¿è¯ºï¼Œå¹¶åœ¨æ¯ä¸ªä»»åŠ¡ç»“æŸæ—¶æ‰§è¡Œã€‚åœ¨æ‰§è¡Œè¿”å›åˆ°äº‹ä»¶å¾ªç¯ä¹‹å‰ï¼Œå§‹ç»ˆæ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚

![The difference between microtasks and tasks](../_img/fast-async/microtasks-vs-tasks.svg)

æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹Jake Archibaldçš„è§£é‡Š[æµè§ˆå™¨ä¸­çš„ä»»åŠ¡ã€å¾®ä»»åŠ¡ã€é˜Ÿåˆ—å’Œè®¡åˆ’](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/).Node.js ä¸­çš„ä»»åŠ¡æ¨¡å‹éå¸¸ç›¸ä¼¼ã€‚

### å¼‚æ­¥å‡½æ•°

æ ¹æ®MDNï¼Œå¼‚æ­¥å‡½æ•°æ˜¯ä½¿ç”¨éšå¼æ‰¿è¯ºå¼‚æ­¥æ“ä½œä»¥è¿”å›å…¶ç»“æœçš„å‡½æ•°ã€‚å¼‚æ­¥å‡½æ•°æ—¨åœ¨ä½¿å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç ï¼Œå‘å¼€å‘äººå‘˜éšè—å¼‚æ­¥å¤„ç†çš„ä¸€äº›å¤æ‚æ€§ã€‚

æœ€ç®€å•çš„å¼‚æ­¥å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š

```js
async function computeAnswer() {
  return 42;
}
```

å½“å®ƒè¢«è°ƒç”¨æ—¶ï¼Œå®ƒå°†è¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼Œæ‚¨å¯ä»¥åƒä»»ä½•å…¶ä»–æ‰¿è¯ºä¸€æ ·è·å¾—å…¶ä»·å€¼ã€‚

```js
const p = computeAnswer();
// â†’ Promise

p.then(console.log);
// prints 42 on the next turn
```

ä½ åªèƒ½å¾—åˆ°è¿™ä¸ªæ‰¿è¯ºçš„ä»·å€¼`p`ä¸‹æ¬¡è¿è¡Œå¾®ä»»åŠ¡æ—¶ã€‚æ¢å¥è¯è¯´ï¼Œä¸Šè¿°ç¨‹åºåœ¨è¯­ä¹‰ä¸Šç­‰æ•ˆäºä½¿ç”¨`Promise.resolve`æ›¿æ¢ä¸ºï¼š

```js
function computeAnswer() {
  return Promise.resolve(42);
}
```

å¼‚æ­¥å‡½æ•°çš„çœŸæ­£å¼ºå¤§ä¹‹å¤„åœ¨äº`await`è¡¨è¾¾å¼ï¼Œå¯¼è‡´å‡½æ•°æ‰§è¡Œæš‚åœï¼Œç›´åˆ°è§£ææ‰¿è¯ºï¼Œå¹¶åœ¨å®ç°åæ¢å¤ã€‚çš„ä»·å€¼`await`æ˜¯åº”éªŒåº”è®¸çš„åº”è®¸ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæ˜¾ç¤ºäº†è¿™æ„å‘³ç€ä»€ä¹ˆï¼š

```js
async function fetchStatus(url) {
  const response = await fetch(url);
  return response.status;
}
```

æ‰§è¡Œ`fetchStatus`åœ¨ ä¸ŠæŒ‚èµ·`await`ï¼Œå¹¶åœ¨`fetch`æ‰¿è¯ºå…‘ç°ã€‚è¿™æˆ–å¤šæˆ–å°‘ç­‰åŒäºå°†å¤„ç†ç¨‹åºé“¾æ¥åˆ°ä»`fetch`.

```js
function fetchStatus(url) {
  return fetch(url).then(response => response.status);
}
```

è¯¥å¤„ç†ç¨‹åºåŒ…å«ä»¥ä¸‹ä»£ç ï¼š`await`åœ¨å¼‚æ­¥å‡½æ•°ä¸­ã€‚

é€šå¸¸ä½ ä¼šé€šè¿‡ä¸€ä¸ª`Promise`è‡ª`await`ï¼Œä½†å®é™…ä¸Šæ‚¨å¯ä»¥ç­‰å¾…ä»»ä½•ä»»æ„ JavaScript å€¼ã€‚å¦‚æœè¡¨è¾¾å¼çš„å€¼è·Ÿåœ¨`await`ä¸æ˜¯æ‰¿è¯ºï¼Œè€Œæ˜¯è½¬æ¢ä¸ºæ‰¿è¯ºã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥`await 42`å¦‚æœä½ è§‰å¾—è¿™æ ·åšï¼š

```js
async function foo() {
  const v = await 42;
  return v;
}

const p = foo();
// â†’ Promise

p.then(console.log);
// prints `42` eventually
```

æ›´æœ‰è¶£çš„æ˜¯ï¼Œ`await`é€‚ç”¨äºä»»ä½•[â€œé‚£ä¹ˆâ€](https://promisesaplus.com/)ï¼Œå³ä»»ä½•å¸¦æœ‰`then`æ–¹æ³•ï¼Œå³ä½¿å®ƒä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ‰¿è¯ºã€‚å› æ­¤ï¼Œæ‚¨å¯ä»¥å®ç°ä¸€äº›æœ‰è¶£çš„äº‹æƒ…ï¼Œä¾‹å¦‚æµ‹é‡å®é™…ç¡çœ æ—¶é—´çš„å¼‚æ­¥ç¡çœ ï¼š

```js
class Sleep {
  constructor(timeout) {
    this.timeout = timeout;
  }
  then(resolve, reject) {
    const startTime = Date.now();
    setTimeout(() => resolve(Date.now() - startTime),
               this.timeout);
  }
}

(async () => {
  const actualTime = await new Sleep(1000);
  console.log(actualTime);
})();
```

è®©æˆ‘ä»¬çœ‹çœ‹ V8 çš„ä½œç”¨`await`åœ¨å¼•æ“ç›–ä¸‹ï¼Œéµå¾ª[è§„èŒƒ](https://tc39.es/ecma262/#await).ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„å¼‚æ­¥å‡½æ•°`foo`:

```js
async function foo(v) {
  const w = await v;
  return w;
}
```

è°ƒç”¨æ—¶ï¼Œå®ƒå°†åŒ…è£…å‚æ•°`v`å¹¶æš‚åœå¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œï¼Œç›´åˆ°è§£æè¯¥æ‰¿è¯ºã€‚ä¸€æ—¦å‘ç”Ÿè¿™ç§æƒ…å†µï¼Œå‡½æ•°çš„æ‰§è¡Œå°†æ¢å¤ï¼Œå¹¶ä¸”`w`åˆ†é…å·²å®ç°æ‰¿è¯ºçš„å€¼ã€‚ç„¶åä»å¼‚æ­¥å‡½æ•°è¿”å›æ­¤å€¼ã€‚

### `await`åœ¨å¼•æ“ç›–ä¸‹

é¦–å…ˆï¼ŒV8 å°†æ­¤å‡½æ•°æ ‡è®°ä¸º*å¯æ¢å¤*ï¼Œè¿™æ„å‘³ç€å¯ä»¥æš‚åœæ‰§è¡Œï¼Œç¨åå†æ¢å¤ï¼ˆåœ¨`await`ç‚¹ï¼‰ã€‚ç„¶åå®ƒåˆ›é€ äº†æ‰€è°“çš„`implicit_promise`ï¼Œè¿™æ˜¯è°ƒç”¨å¼‚æ­¥å‡½æ•°æ—¶è¿”å›çš„ promiseï¼Œå®ƒæœ€ç»ˆè§£æä¸º async å‡½æ•°ç”Ÿæˆçš„å€¼ã€‚

![Comparison between a simple async function and what the engine turns it into](../_img/fast-async/await-under-the-hood.svg)

ç„¶åæ˜¯æœ‰è¶£çš„ä¸€ç‚¹ï¼šå®é™…`await`.é¦–å…ˆå°†å€¼ä¼ é€’ç»™`await`è¢«åŒ…è£¹æˆä¸€ä¸ªæ‰¿è¯ºã€‚ç„¶åï¼Œå°†å¤„ç†ç¨‹åºé™„åŠ åˆ°æ­¤åŒ…è£…çš„ promiseï¼Œä»¥ä¾¿åœ¨ promise å®ç°åæ¢å¤è¯¥å‡½æ•°ï¼Œå¹¶æš‚åœ async å‡½æ•°çš„æ‰§è¡Œï¼Œè¿”å›`implicit_promise`ç»™è°ƒç”¨æ–¹ã€‚ä¸€æ—¦`promise`å®Œæˆï¼Œåˆ™ä½¿ç”¨å€¼æ¢å¤å¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œ`w`ä»`promise`ï¼Œä»¥åŠ`implicit_promise`é€šè¿‡`w`.

ç®€è€Œè¨€ä¹‹ï¼Œåˆæ­¥æ­¥éª¤`await v`æ˜¯ï¼š

1.  åŒ…è£…`v`â€” ä¼ é€’ç»™çš„å€¼`await`â€”â€” å˜æˆä¸€ä¸ªæ‰¿è¯ºã€‚
2.  é™„åŠ å¤„ç†ç¨‹åºä»¥ä¾¿ç¨åæ¢å¤å¼‚æ­¥å‡½æ•°ã€‚
3.  æš‚åœå¼‚æ­¥å‡½æ•°å¹¶è¿”å›`implicit_promise`ç»™è°ƒç”¨æ–¹ã€‚

è®©æˆ‘ä»¬é€æ­¥å®Œæˆå„ä¸ªæ“ä½œã€‚å‡è®¾æ­£åœ¨è¢«çš„ä¸œè¥¿`await`edå·²ç»æ˜¯ä¸€ä¸ªæ‰¿è¯ºï¼Œå®ƒçš„ä»·å€¼å·²ç»å®ç°`42`.ç„¶åï¼Œå¼•æ“å°†åˆ›å»ºä¸€ä¸ªæ–°çš„`promise`å¹¶ç”¨ä»»ä½•å­˜åœ¨çš„ä¸œè¥¿è§£å†³è¿™ä¸ªé—®é¢˜`await`ç¼–è¾‘ã€‚è¿™åœ¨ä¸‹ä¸€è½®æ—¶å°†è¿™äº›æ‰¿è¯ºçš„å»¶è¿Ÿé“¾æ¥ï¼Œé€šè¿‡è§„èŒƒæ‰€ç§°çš„[`PromiseResolveThenableJob`](https://tc39.es/ecma262/#sec-promiseresolvethenablejob).

![](../_img/fast-async/await-step-1.svg)

ç„¶åå¼•æ“åˆ›å»ºå¦ä¸€ä¸ªæ‰€è°“çš„`throwaway`æ‰¿è¯ºã€‚å®ƒè¢«ç§°ä¸º*ä¸€æ¬¡æ€§*å› ä¸ºæ²¡æœ‰ä»»ä½•ä¸œè¥¿è¢«æŸç¼šåœ¨å®ƒä¸Šé¢ - å®ƒå®Œå…¨æ˜¯å¼•æ“å†…éƒ¨çš„ã€‚è¿™`throwaway`ç„¶åï¼Œæ‰¿è¯ºè¢«é“¾æ¥åˆ°`promise`ï¼Œå¹¶ä½¿ç”¨é€‚å½“çš„å¤„ç†ç¨‹åºæ¢å¤å¼‚æ­¥å‡½æ•°ã€‚è¿™`performPromiseThen`æ“ä½œæœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆ[`Promise.prototype.then()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then)ç¡®å®å¦‚æ­¤ï¼Œåœ¨å¹•åã€‚æœ€åï¼Œæš‚åœå¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œï¼Œå¹¶å°†æ§åˆ¶æƒè¿”å›ç»™è°ƒç”¨æ–¹ã€‚

![](../_img/fast-async/await-step-2.svg)

è°ƒç”¨æ–¹ä¸­çš„æ‰§è¡Œç»§ç»­ï¼Œæœ€ç»ˆè°ƒç”¨å †æ ˆå˜ä¸ºç©ºã€‚ç„¶åJavaScriptå¼•æ“å¼€å§‹è¿è¡Œå¾®ä»»åŠ¡ï¼šå®ƒè¿è¡Œå…ˆå‰è®¡åˆ’çš„å†…å®¹[`PromiseResolveThenableJob`](https://tc39.es/ecma262/#sec-promiseresolvethenablejob)ï¼Œè¿™å°†å®‰æ’æ–°çš„[`PromiseReactionJob`](https://tc39.es/ecma262/#sec-promisereactionjob)ä»¥é“¾æ¥`promise`åˆ°ä¼ é€’ç»™çš„å€¼ä¸Š`await`.ç„¶åï¼Œå¼•æ“è¿”å›åˆ°å¤„ç†å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå› ä¸ºåœ¨ç»§ç»­ä¸»äº‹ä»¶å¾ªç¯ä¹‹å‰å¿…é¡»æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚

![](../_img/fast-async/await-step-3.svg)

æ¥ä¸‹æ¥æ˜¯[`PromiseReactionJob`](https://tc39.es/ecma262/#sec-promisereactionjob)ï¼Œå®ƒæ»¡è¶³`promise`ä»æ‰¿è¯ºçš„ä»·å€¼ï¼Œæˆ‘ä»¬æ˜¯`await`ing â€”`42`åœ¨è¿™ç§æƒ…å†µä¸‹ â€” å¹¶å°†ååº”å®‰æ’åˆ°`throwaway`æ‰¿è¯ºã€‚ç„¶åï¼Œå¼•æ“å†æ¬¡è¿”å›åˆ°å¾®ä»»åŠ¡å¾ªç¯ï¼Œå…¶ä¸­åŒ…å«è¦å¤„ç†çš„æœ€ç»ˆå¾®ä»»åŠ¡ã€‚

![](../_img/fast-async/await-step-4-final.svg)

ç°åœ¨è¿™ä¸€ç§’[`PromiseReactionJob`](https://tc39.es/ecma262/#sec-promisereactionjob)å°†åˆ†è¾¨ç‡ä¼ æ’­åˆ°`throwaway`promiseï¼Œå¹¶æ¢å¤å¼‚æ­¥å‡½æ•°çš„æŒ‚èµ·æ‰§è¡Œï¼Œè¿”å›å€¼`42`ä»`await`.

![Summary of the overhead of await](../_img/fast-async/await-overhead.svg)

æ€»ç»“æˆ‘ä»¬å­¦åˆ°çš„ä¸œè¥¿ï¼Œå¯¹äºæ¯ä¸ª`await`å¼•æ“å¿…é¡»åˆ›å»º**ä¸¤ä¸ªé¢å¤–çš„**æ‰¿è¯ºï¼ˆå³ä½¿å³æ‰‹è¾¹å·²ç»æ˜¯æ‰¿è¯ºï¼‰å¹¶ä¸”å®ƒéœ€è¦**è‡³å°‘ä¸‰ä¸ª**å¾®ä»»åŠ¡é˜Ÿåˆ—æ»´ç­”å£°ã€‚è°çŸ¥é“å•èº«`await`è¡¨è¾¾å¼å¯¼è‡´*é‚£ä¹ˆå¤šçš„å¼€é”€*?!

![](../_img/fast-async/await-code-before.svg)

è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªå¼€é”€æ¥è‡ªå“ªé‡Œã€‚ç¬¬ä¸€è¡Œè´Ÿè´£åˆ›å»ºåŒ…è£…å™¨æ‰¿è¯ºã€‚ç¬¬äºŒè¡Œç«‹å³è§£æåŒ…è£…å™¨æ‰¿è¯ºä¸`await`ed å€¼`v`.è¿™ä¸¤æ¡çº¿è´Ÿè´£ä¸€ä¸ªé¢å¤–çš„æ‰¿è¯ºåŠ ä¸Šä¸‰ä¸ªå¾®åˆ†ä¸­çš„ä¸¤ä¸ªã€‚å¦‚æœ`v`å·²ç»æ˜¯ä¸€ä¸ªæ‰¿è¯ºï¼ˆè¿™æ˜¯å¸¸è§çš„æƒ…å†µï¼Œå› ä¸ºåº”ç”¨ç¨‹åºé€šå¸¸`await`æ‰¿è¯ºï¼‰ã€‚åœ¨ä¸å¤ªå¯èƒ½çš„æƒ…å†µä¸‹ï¼Œå¼€å‘äººå‘˜`await`s ä¸Šï¼Œä¾‹å¦‚`42`ï¼Œå¼•æ“ä»ç„¶éœ€è¦å°†å…¶åŒ…è£…æˆä¸€ä¸ªæ‰¿è¯ºã€‚

äº‹å®è¯æ˜ï¼Œå·²ç»æœ‰ä¸€ä¸ª[`promiseResolve`](https://tc39.es/ecma262/#sec-promise-resolve)è§„èŒƒä¸­ä»…åœ¨éœ€è¦æ—¶æ‰§è¡ŒåŒ…è£…çš„æ“ä½œï¼š

![](../_img/fast-async/await-code-comparison.svg)

æ­¤æ“ä½œè¿”å›æœªæ›´æ”¹çš„ promiseï¼Œå¹¶ä¸”ä»…åœ¨å¿…è¦æ—¶å°†å…¶ä»–å€¼åŒ…è£…åˆ° promise ä¸­ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ‚¨å¯ä»¥ä¿å­˜å…¶ä¸­ä¸€ä¸ªé™„åŠ æ‰¿è¯ºï¼ŒåŠ ä¸Šå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸Šçš„ä¸¤ä¸ªåˆ»åº¦çº¿ï¼Œç”¨äºå°†å€¼ä¼ é€’ç»™çš„å¸¸è§æƒ…å†µ`await`å·²ç»æ˜¯ä¸€ä¸ªæ‰¿è¯ºã€‚æ­¤æ–°è¡Œä¸ºå·²[åœ¨ V8 v7.2 ä¸­é»˜è®¤å¯ç”¨](/blog/v8-release-72#async%2Fawait).å¯¹äº V8 v7.1ï¼Œå¯ä»¥ä½¿ç”¨`--harmony-await-optimization`æ——ã€‚æˆ‘ä»¬å·²ç»[å»ºè®®å¯¹ ECMAScript è§„èŒƒè¿›è¡Œæ­¤æ›´æ”¹](https://github.com/tc39/ecma262/pull/1250)ä¹Ÿã€‚

ä»¥ä¸‹æ˜¯æ–°çš„å’Œæ”¹è¿›çš„æ–¹æ³•`await`å¹•åå·¥ä½œï¼Œä¸€æ­¥ä¸€æ­¥ï¼š

![](../_img/fast-async/await-new-step-1.svg)

è®©æˆ‘ä»¬å†æ¬¡å‡è®¾æˆ‘ä»¬`await`ä¸€ä¸ªæ‰¿è¯ºï¼Œå·²ç»å®ç°`42`.å¤šäºäº†ç¥å¥‡çš„[`promiseResolve`](https://tc39.es/ecma262/#sec-promise-resolve)è¿™`promise`ç°åœ¨åªæ˜¯æŒ‡åŒæ ·çš„åº”è®¸`v`ï¼Œå› æ­¤æ­¤æ­¥éª¤ä¸­æ— éœ€æ‰§è¡Œä»»ä½•æ“ä½œã€‚ä¹‹åï¼Œå¼•æ“ç»§ç»­åƒä»¥å‰ä¸€æ ·ï¼Œåˆ›å»º`throwaway`æ‰¿è¯ºï¼Œè°ƒåº¦ä¸€ä¸ª[`PromiseReactionJob`](https://tc39.es/ecma262/#sec-promisereactionjob)åœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—çš„ä¸‹ä¸€ä¸ª tick ä¸Šæ¢å¤å¼‚æ­¥å‡½æ•°ï¼Œæš‚åœå‡½æ•°çš„æ‰§è¡Œï¼Œç„¶åè¿”å›è°ƒç”¨æ–¹ã€‚

![](../_img/fast-async/await-new-step-2.svg)

ç„¶åï¼Œæœ€ç»ˆå½“æ‰€æœ‰JavaScriptæ‰§è¡Œå®Œæˆæ—¶ï¼Œå¼•æ“å¼€å§‹è¿è¡Œå¾®ä»»åŠ¡ï¼Œå› æ­¤å®ƒæ‰§è¡Œ[`PromiseReactionJob`](https://tc39.es/ecma262/#sec-promisereactionjob).æ­¤ä½œä¸šä¼ æ’­åˆ†è¾¨ç‡`promise`è‡ª`throwaway`ï¼Œç„¶åæ¢å¤å¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œï¼Œä»è€Œäº§ç”Ÿ`42`ä»`await`.

![Summary of the reduction in await overhead](../_img/fast-async/await-overhead-removed.svg)

æ­¤ä¼˜åŒ–é¿å…äº†åœ¨å°†å€¼ä¼ é€’ç»™`await`å·²ç»æ˜¯ä¸€ä¸ªæ‰¿è¯ºï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä»æœ€ä½é™åº¦**ä¸‰**å¾®åˆ†æµåˆ°åªæ˜¯**ä¸€**å¾®æ»´ç­”ã€‚æ­¤è¡Œä¸ºç±»ä¼¼äº Node.js 8 æ‰€åšçš„ï¼Œåªæ˜¯ç°åœ¨å®ƒä¸å†æ˜¯ä¸€ä¸ªé”™è¯¯ - å®ƒç°åœ¨æ˜¯ä¸€ä¸ªæ­£åœ¨æ ‡å‡†åŒ–çš„ä¼˜åŒ–ï¼

å®ƒä»ç„¶æ„Ÿè§‰ä¸å¯¹ï¼Œå¼•æ“å¿…é¡»åˆ›å»ºè¿™ä¸ª`throwaway`æ‰¿è¯ºï¼Œå°½ç®¡å®Œå…¨æ˜¯å¼•æ“çš„å†…éƒ¨ã€‚äº‹å®è¯æ˜ï¼Œ`throwaway`æ‰¿è¯ºåªæ˜¯ä¸ºäº†æ»¡è¶³å†…éƒ¨çš„APIçº¦æŸ`performPromiseThen`è§„èŒƒä¸­çš„æ“ä½œã€‚

![](../_img/fast-async/await-optimized.svg)

æœ€è¿‘åœ¨ä¸€ä¸ª[ç¼–è¾‘æ›´æ”¹](https://github.com/tc39/ecma262/issues/694)åˆ° ECMAScript è§„èŒƒã€‚å¼•æ“ä¸å†éœ€è¦åˆ›å»º`throwaway`æ‰¿è¯º`await`â€” å¤§å¤šæ•°æ—¶å€™\[^2]ã€‚

\[^2]ï¼šV8 ä»ç„¶éœ€è¦åˆ›å»º`throwaway`æ‰¿è¯ºå¦‚æœ[`async_hooks`](https://nodejs.org/api/async_hooks.html)æ­£åœ¨ Node.js ä¸­ä½¿ç”¨ï¼Œå› ä¸º`before`å’Œ`after`é’©å­åœ¨*ä¸Šä¸‹æ–‡*çš„`throwaway`æ‰¿è¯ºã€‚

![Comparison of await code before and after the optimizations](../_img/fast-async/node-10-vs-node-12.svg)

æ¯”è¾ƒ`await`åœ¨èŠ‚ç‚¹ä¸­.js 10 åˆ°ä¼˜åŒ–`await`è¿™å¾ˆå¯èƒ½åœ¨ Node ä¸­.js 12 æ˜¾ç¤ºäº†æ­¤æ›´æ”¹å¯¹æ€§èƒ½çš„å½±å“ï¼š

![](../_img/fast-async/benchmark-optimization.svg)

**`async`/`await`ç°åœ¨ä¼˜äºæ‰‹å†™çš„æ‰¿è¯ºä»£ç **.è¿™é‡Œçš„å…³é”®æ˜¯ï¼Œæˆ‘ä»¬é€šè¿‡ä¿®è¡¥è§„èŒƒï¼Œæ˜¾è‘—é™ä½äº†å¼‚æ­¥å‡½æ•°çš„å¼€é”€ â€”â€”ä¸ä»…åœ¨ V8 ä¸­ï¼Œè€Œä¸”åœ¨æ‰€æœ‰ JavaScript å¼•æ“ä¸­ã€‚

**æ›´æ–°ï¼š**ä» V8 v7.2 å’Œ Chrome 72 å¼€å§‹ï¼Œ`--harmony-await-optimization`é»˜è®¤æƒ…å†µä¸‹å¤„äºå¯ç”¨çŠ¶æ€ã€‚[è¡¥ä¸](https://github.com/tc39/ecma262/pull/1250)åˆ° ECMAScript è§„èŒƒè¢«åˆå¹¶ã€‚

## æ”¹è¿›çš„å¼€å‘äººå‘˜ä½“éªŒ

é™¤äº†æ€§èƒ½ä¹‹å¤–ï¼ŒJavaScriptå¼€å‘äººå‘˜è¿˜å…³å¿ƒè¯Šæ–­å’Œä¿®å¤é—®é¢˜çš„èƒ½åŠ›ï¼Œè¿™åœ¨å¤„ç†å¼‚æ­¥ä»£ç æ—¶å¹¶ä¸æ€»æ˜¯é‚£ä¹ˆå®¹æ˜“ã€‚[Chrome DevTools](https://developers.google.com/web/tools/chrome-devtools)æ”¯æŒ*å¼‚æ­¥å †æ ˆè·Ÿè¸ª*ï¼Œå³å †æ ˆè·Ÿè¸ªï¼Œå…¶ä¸­ä¸ä»…åŒ…æ‹¬å †æ ˆçš„å½“å‰åŒæ­¥éƒ¨åˆ†ï¼Œè¿˜åŒ…æ‹¬å¼‚æ­¥éƒ¨åˆ†ï¼š

![](../_img/fast-async/devtools.png)

è¿™æ˜¯æœ¬åœ°å¼€å‘è¿‡ç¨‹ä¸­éå¸¸æœ‰ç”¨çš„åŠŸèƒ½ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦éƒ¨ç½²äº†åº”ç”¨ç¨‹åºï¼Œæ­¤æ–¹æ³•å¹¶ä¸èƒ½çœŸæ­£å¸®åŠ©æ‚¨ã€‚åœ¨äº‹åè°ƒè¯•æœŸé—´ï¼Œæ‚¨åªä¼šçœ‹åˆ°`Error#stack`è¾“å‡ºåœ¨æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œè¿™å¹¶ä¸èƒ½å‘Šè¯‰æ‚¨æœ‰å…³å¼‚æ­¥éƒ¨åˆ†çš„ä»»ä½•ä¿¡æ¯ã€‚

æˆ‘ä»¬æœ€è¿‘ä¸€ç›´åœ¨åŠªåŠ›[*é›¶æˆæœ¬å¼‚æ­¥å †æ ˆè·Ÿè¸ª*](https://bit.ly/v8-zero-cost-async-stack-traces)è¿™ä¸°å¯Œäº†`Error#stack`å…·æœ‰å¼‚æ­¥å‡½æ•°è°ƒç”¨çš„å±æ€§ã€‚â€œé›¶æˆæœ¬â€å¬èµ·æ¥å¾ˆä»¤äººå…´å¥‹ï¼Œä¸æ˜¯å—ï¼Ÿå½“Chrome DevToolsåŠŸèƒ½å¸¦æ¥é‡å¤§å¼€é”€æ—¶ï¼Œå®ƒæ€ä¹ˆå¯èƒ½æ˜¯é›¶æˆæœ¬çš„ï¼Ÿè€ƒè™‘æ­¤ç¤ºä¾‹ï¼Œå…¶ä¸­`foo`è°ƒç”¨`bar`å¼‚æ­¥ï¼Œä»¥åŠ`bar`åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å¼•å‘å¼‚å¸¸`await`æ‰¿è¯ºï¼š

```js
async function foo() {
  await bar();
  return 42;
}

async function bar() {
  await Promise.resolve();
  throw new Error('BEEP BEEP');
}

foo().catch(error => console.log(error.stack));
```

åœ¨ Node.js 8 æˆ– Node.js 10 ä¸­è¿è¡Œæ­¤ä»£ç ä¼šäº§ç”Ÿä»¥ä¸‹è¾“å‡ºï¼š

```text/2
$ node index.js
Error: BEEP BEEP
    at bar (index.js:8:9)
    at process._tickCallback (internal/process/next_tick.js:68:7)
    at Function.Module.runMain (internal/modules/cjs/loader.js:745:11)
    at startup (internal/bootstrap/node.js:266:19)
    at bootstrapNodeJSCore (internal/bootstrap/node.js:595:3)
```

è¯·æ³¨æ„ï¼Œå°½ç®¡è°ƒç”¨`foo()`å¯¼è‡´é”™è¯¯ï¼Œ`foo`æ ¹æœ¬ä¸æ˜¯å †æ ˆè·Ÿè¸ªçš„ä¸€éƒ¨åˆ†ã€‚è¿™ä½¿å¾— JavaScript å¼€å‘äººå‘˜å¾ˆéš¾æ‰§è¡Œäº‹åè°ƒè¯•ï¼Œè€Œä¸ç®¡ä½ çš„ä»£ç æ˜¯éƒ¨ç½²åœ¨ Web åº”ç”¨ç¨‹åºä¸­è¿˜æ˜¯éƒ¨ç½²åœ¨æŸäº›äº‘å®¹å™¨ä¸­ã€‚

è¿™é‡Œæœ‰è¶£çš„æ˜¯ï¼Œå¼•æ“çŸ¥é“å®ƒå¿…é¡»åœ¨å“ªé‡Œç»§ç»­`bar`å®Œæˆï¼šç´§æ¥åœ¨`await`åœ¨å‡½æ•°ä¸­`foo`.å·§åˆçš„æ˜¯ï¼Œè¿™ä¹Ÿæ˜¯å‡½æ•°çš„åœ°æ–¹`foo`å·²æš‚åœã€‚å¼•æ“å¯ä»¥ä½¿ç”¨æ­¤ä¿¡æ¯æ¥é‡å»ºéƒ¨åˆ†å¼‚æ­¥å †æ ˆè·Ÿè¸ªï¼Œå³`await`ç½‘ç«™ã€‚è¿›è¡Œæ­¤æ›´æ”¹åï¼Œè¾“å‡ºå˜ä¸ºï¼š

```text/2,7
$ node --async-stack-traces index.js
Error: BEEP BEEP
    at bar (index.js:8:9)
    at process._tickCallback (internal/process/next_tick.js:68:7)
    at Function.Module.runMain (internal/modules/cjs/loader.js:745:11)
    at startup (internal/bootstrap/node.js:266:19)
    at bootstrapNodeJSCore (internal/bootstrap/node.js:595:3)
    at async foo (index.js:2:3)
```

åœ¨å †æ ˆè·Ÿè¸ªä¸­ï¼Œæœ€ä¸Šé¢çš„å‡½æ•°æ’åœ¨ç¬¬ä¸€ä½ï¼Œç„¶åæ˜¯åŒæ­¥å †æ ˆè·Ÿè¸ªçš„å…¶ä½™éƒ¨åˆ†ï¼Œç„¶åæ˜¯å¼‚æ­¥è°ƒç”¨`bar`åœ¨å‡½æ•°ä¸­`foo`.æ­¤æ›´æ”¹åœ¨ V8 ä¸­å®ç°ï¼Œåœ¨æ–°çš„`--async-stack-traces`æ——ã€‚**æ›´æ–°**ï¼šä» V8 v7.3 å¼€å§‹ï¼Œ`--async-stack-traces`é»˜è®¤æƒ…å†µä¸‹å¤„äºå¯ç”¨çŠ¶æ€ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæ‚¨å°†å…¶ä¸ä¸Šé¢çš„ Chrome DevTools ä¸­çš„å¼‚æ­¥å †æ ˆè·Ÿè¸ªè¿›è¡Œæ¯”è¾ƒï¼Œæ‚¨ä¼šæ³¨æ„åˆ°å®é™…çš„è°ƒç”¨ç«™ç‚¹`foo`åœ¨å †æ ˆè·Ÿè¸ªçš„å¼‚æ­¥éƒ¨åˆ†ä¸­ä¸¢å¤±ã€‚å¦‚å‰æ‰€è¿°ï¼Œè¿™ç§æ–¹æ³•åˆ©ç”¨äº†ä»¥ä¸‹äº‹å®ï¼š`await`æ¢å¤å’Œæš‚åœä½ç½®æ˜¯ç›¸åŒçš„ - ä½†å¯¹äºå¸¸è§„[`Promise#then()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then)æˆ–[`Promise#catch()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch)ç”µè¯ï¼Œäº‹å®å¹¶éå¦‚æ­¤ã€‚æœ‰å…³æ›´å¤šèƒŒæ™¯ä¿¡æ¯ï¼Œè¯·å‚é˜… Mathias Bynens çš„è§£é‡Š[ä¸ºä»€ä¹ˆ`await`æ‰“`Promise#then()`](https://mathiasbynens.be/notes/async-stack-traces).

## ç»“è®º

ç”±äºä¸¤é¡¹é‡è¦çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬ä½¿å¼‚æ­¥å‡½æ•°æ›´å¿«ï¼š

*   å»é™¤ä¸¤ä¸ªé¢å¤–çš„å¾®å­”ï¼Œä»¥åŠ
*   åˆ é™¤`throwaway`æ‰¿è¯ºã€‚

æœ€é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬é€šè¿‡ä»¥ä¸‹æ–¹å¼æ”¹è¿›äº†å¼€å‘äººå‘˜ä½“éªŒï¼š[*é›¶æˆæœ¬å¼‚æ­¥å †æ ˆè·Ÿè¸ª*](https://bit.ly/v8-zero-cost-async-stack-traces)ï¼Œé€‚ç”¨äº`await`åœ¨å¼‚æ­¥å‡½æ•°ä¸­ï¼Œå¹¶ä¸”`Promise.all()`.

æˆ‘ä»¬è¿˜ä¸ºJavaScriptå¼€å‘äººå‘˜æä¾›äº†ä¸€äº›ä¸é”™çš„æ€§èƒ½å»ºè®®ï¼š

*   å–œçˆ±`async`å‡½æ•°å’Œ`await`é€šè¿‡æ‰‹å†™çš„æ‰¿è¯ºä»£ç ï¼Œä»¥åŠ
*   åšæŒä½¿ç”¨JavaScriptå¼•æ“æä¾›çš„æœ¬æœºæ‰¿è¯ºå®ç°ï¼Œä»¥ä»å¿«æ·æ–¹å¼ä¸­å—ç›Šï¼Œå³é¿å…ä¸¤ä¸ªmicroticks`await`.
