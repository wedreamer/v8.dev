***

标题： “启动点火解释器”
作者：“Ross McIlroy，V8 Ignition Jump Starter”
化身：

*   “罗斯-麦克罗伊”
    日期： 2016-08-23 13：33：37
    标签：
*   内部
    描述：“使用Ignition解释器，V8将JavaScript函数编译为简洁的字节码，其大小在等效基线机器代码的50%到25%之间。

***

V8 和其他现代 JavaScript 引擎通过以下方式获得速度[实时 （JIT） 编译](https://en.wikipedia.org/wiki/Just-in-time_compilation)在执行之前将脚本转换为本机机器代码。代码最初由基线编译器编译，该编译器可以快速生成未优化的机器代码。编译后的代码在运行时进行分析，并可以选择使用更高级的优化编译器动态重新编译，以实现最佳性能。在 V8 中，此脚本执行流水线具有各种特殊情况和条件，需要复杂的机器在基线编译器和两个优化编译器 Crankshaft 和 TurboFan 之间切换。

这种方法的一个问题（除了架构复杂性之外）是JITed机器代码可以消耗大量的内存，即使代码只执行一次。为了减轻这种开销，V8 团队构建了一个新的 JavaScript 解释器，称为 Ignition，它可以取代 V8 的基线编译器，以更少的内存开销执行代码，并为更简单的脚本执行管道铺平道路。

使用Ignition，V8将JavaScript函数编译为简洁的字节码，其大小在等效基线机器码的50%到25%之间。然后，该字节码由高性能解释器执行，该解释器在现实世界网站上的执行速度接近V8现有基线编译器生成的代码的执行速度。

在Chrome 53中，Ignition将适用于RAM有限（512 MB或更小）的Android设备，其中最需要节省内存。该领域早期实验的结果表明，Ignition将每个Chrome标签的内存减少了约5%。

![V8’s compilation pipeline with Ignition enabled](/\_img/ignition-interpreter/ignition-pipeline.png)

## 详

在构建Ignition的字节码解释器时，该团队考虑了许多潜在的实现方法。用C++编写的传统解释器将无法与V8生成的代码的其余部分进行有效的交互。另一种选择是在汇编代码中手动编写解释器代码，但是鉴于V8支持九个架构端口，这将需要大量的工程开销。

相反，我们选择了一种利用TurboFan优势的方法，TurboFan是我们新的优化编译器，它已经进行了调整，可以与V8运行时和其他生成的代码进行最佳交互。Ignition解释器使用TurboFan的低级，独立于架构的宏汇编指令为每个操作码生成字节码处理程序。TurboFan将这些指令编译到目标架构中，在此过程中执行低级指令选择和机器寄存器分配。这导致了高度优化的解释器代码，它可以执行字节码指令，并以低开销的方式与V8虚拟机的其余部分进行交互，只需向代码库添加最少的新机器。

Ignition是一个寄存器机器，每个字节码将其输入和输出指定为显式寄存器操作数，而不是堆栈机器，其中每个字节码将消耗输入并推送隐式堆栈上的输出。特殊的累加器寄存器是许多字节码的隐式输入和输出寄存器。这样可以避免指定特定的寄存器操作数，从而减小字节码的大小。由于许多JavaScript表达式涉及从左到右计算的操作链，因此在整个表达式的评估过程中，这些操作的临时结果通常可以保留在累加器中，从而最大限度地减少了加载和存储到显式寄存器的操作的需求。

生成字节码时，它会经历一系列内联优化阶段。这些阶段对字节码流执行简单的分析，用更快的序列替换常见模式，删除一些冗余操作，并最大限度地减少不必要的寄存器加载和传输的数量。总之，优化进一步减小了字节码的大小并提高了性能。

有关 Ignition 实现的更多详细信息，请参阅我们的 BlinkOn 讲座：

<figure>
  <div class="video video-16:9">
    <iframe src="https://www.youtube.com/embed/r5OWCtuKiAk" width="640" height="360" loading="lazy"></iframe>
  </div>
</figure>

## 前途

到目前为止，我们对Ignition的重点是减少V8的内存开销。但是，将 Ignition 添加到我们的脚本执行管道中会开辟许多未来的可能性。Ignition管道旨在使我们能够对何时执行和优化代码做出更明智的决策，以加快加载网页并减少卡顿，并使V8的各种组件之间的交换更加高效。

请继续关注Ignition和V8的未来发展。
