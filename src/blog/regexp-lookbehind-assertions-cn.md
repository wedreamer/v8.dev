***

标题： “正则表达式查找后置断言”
作者：“Yang Guo，正则表达式工程师”
化身：

*   “阳国”
    日期： 2016-02-26 13：33：37
    标签：
*   ECMAScript
*   正则表达式
    描述：“JavaScript 正则表达式正在获得一些新功能：查看断言。

***

自 1999 年以来，正则表达式随 ECMA-262 规范的第三版一起引入，一直是 Javascript 的一部分。在功能和表现力方面，JavaScript的正则表达式实现大致反映了其他编程语言的实现。

JavaScript 的 RegExp 中有一个经常被忽视但有时非常有用的功能是前瞻断言。例如，要匹配后跟百分号的数字序列，我们可以使用`/\d+(?=%)/`.百分号本身不是匹配结果的一部分。否定其，`/\d+(?!%)/`，将匹配不后跟百分号的数字序列：

```js
/\d+(?=%)/.exec('100% of US presidents have been male'); // ['100']
/\d+(?!%)/.exec('that’s all 44 of them');                // ['44']
```

与 lookahead 相反，lookbehind 断言在 JavaScript 中缺失，但在其他正则表达式实现（如 .NET 框架的正则表达式实现）中可用。正则表达式引擎不是提前读取，而是向后读取断言内的匹配项。美元符号后面的数字序列可以匹配`/(?<=\$)\d+/`，其中美元符号不是匹配结果的一部分。否定其，`/(?<!\$)\d+/`，匹配除美元符号以外的任何数字后面的数字序列。

```js
/(?<=\$)\d+/.exec('Benjamin Franklin is on the $100 bill'); // ['100']
/(?<!\$)\d+/.exec('it’s worth about €90');                  // ['90']
```

通常，有两种方法可以实现查看断言。例如，Perl要求视入模式具有固定的长度。这意味着量词，例如`*`或`+`是不允许的。这样，正则表达式引擎可以后退一步，并按照该固定长度进行后退，并以与从后退位置匹配前瞻完全相同的方式匹配前置。

.NET 框架中的正则表达式引擎采用不同的方法。它不需要知道查找后方模式将匹配多少个字符，只需向后匹配后置模式，同时根据正常读取方向读取字符。这意味着 lookbehind 模式可以利用完整的正则表达式语法并匹配任意长度的模式。

显然，第二种选择比第一种选择更强大。这就是为什么 V8 团队和 TC39 的这个特性的拥护者一致认为 JavaScript 应该采用更具表现力的版本，尽管它的实现稍微复杂一些。

由于 lookbehind 断言是向后匹配的，所以有一些微妙的行为会被认为是令人惊讶的。例如，具有量词的捕获组捕获最后一个匹配项。通常，这是最正确的匹配项。但是在一个 lookinbehind 断言中，我们从右到左匹配，因此捕获最左边的匹配：

```js
/h(?=(\w)+)/.exec('hodor');  // ['h', 'r']
/(?<=(\w)+)r/.exec('hodor'); // ['r', 'h']
```

捕获组在捕获后，可以通过反向引用来引用该组。通常，后面的引用必须位于捕获组的右侧。否则，它将与空字符串匹配，因为尚未捕获任何内容。但是，在查看断言中，匹配方向是相反的：

```js
/(?<=(o)d\1)r/.exec('hodor'); // null
/(?<=\1d(o))r/.exec('hodor'); // ['r', 'o']
```

Lookbehind断言目前在一个非常[早期](https://github.com/tc39/proposal-regexp-lookbehind)在 TC39 规范流程中。但是，由于它们是 RegExp 语法的明显扩展，因此我们决定确定其实现的优先级。您已经可以通过运行 V8 版本 4.9 或更高版本来试验查找隐藏断言`--harmony`，或通过启用实验性 JavaScript 功能（使用`about:flags`），从版本 49 开始。
