***

标题： “暂时禁用逃逸分析”
作者： 马蒂亚斯·拜恩斯 （[@mathias](https://twitter.com/mathias)），沙盒逃逸分析仪
化身：

*   'mathias-bynens'
    日期： 2017-09-22 13：33：37
    标签：
*   安全
    描述： “我们在 Chrome 61 中禁用了 V8 的逃逸分析，以保护用户免受安全漏洞的侵害。
    推文：“911339802884284416”

***

在 JavaScript 中，这指的是一个已分配的对象*逃脱*如果可以从当前函数外部访问它。通常，V8 在 JavaScript 堆上分配新对象，但使用*逃逸分析*，优化编译器可以确定何时可以对对象进行特殊处理，因为它的生存期可证明地绑定到函数的激活。当对新分配对象的引用未转义创建它的函数时，JavaScript 引擎不需要在堆上显式分配该对象。相反，它们可以有效地将对象的值视为函数的局部变量。这反过来又支持各种优化，例如将这些值存储在堆栈或寄存器中，或者在某些情况下，完全优化这些值。转义的对象（更准确地说，是无法证明不转义的对象）必须进行堆分配。

例如，转义分析使 V8 能够有效地重写以下代码：

```js
function foo(a, b) {
  const object = { a, b };
  return object.a + object.b;
  // Note: `object` does not escape.
}
```

...到此代码中，从而实现了几个引擎盖下的优化：

```js
function foo(a, b) {
  const object_a = a;
  const object_b = b;
  return object_a + object_b;
}
```

V8 v6.1 及更早版本使用的是一种转义分析实现，该实现非常复杂，并且自推出以来会产生许多 bug。此实现已被删除，并且提供了全新的转义分析代码库，可在[V8 v6.2](/blog/v8-release-62).

然而[一个 Chrome 安全漏洞](https://chromereleases.googleblog.com/2017/09/stable-channel-update-for-desktop\_21.html)涉及V8 v6.1中旧的逃逸分析实现已经被发现并负责任地披露给我们。为了保护用户，我们在 Chrome 61 中关闭了逃逸分析功能。Node.js应该不会受到影响，因为该漏洞取决于不受信任的 JavaScript 的执行。

关闭转义分析会对性能产生负面影响，因为它会禁用上述优化。具体而言，以下 ES2015 功能可能会暂时减速：

*   解构
*   `for`-`of`迭 代
*   阵列展开
*   休息参数

请注意，禁用逃逸分析只是一种临时措施。借助 Chrome 62，我们将推出全新的逃逸分析（最重要的是启用）实现，如 V8 v6.2 所示。
